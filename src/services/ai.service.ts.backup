import OpenAI from 'openai';
import { config } from '../config/env';
import { Stream } from 'openai/streaming';

export class AIService {
    private openai: OpenAI;

    constructor() {
        this.openai = new OpenAI({
            apiKey: config.GROQ_API_KEY,
            baseURL: config.AI_BASE_URL,
        });
    }

    async getResponseStream(
        messages: { role: 'system' | 'user' | 'assistant'; content: string }[]
    ): Promise<Stream<OpenAI.Chat.Completions.ChatCompletionChunk>> {
        try {
            const stream = await this.openai.chat.completions.create({
                model: config.AI_MODEL,
                messages: messages,
                stream: true,
                temperature: 0.7,
                max_tokens: 1024,
            });
            return stream;
        } catch (error) {
            console.error('Error getting AI response:', error);
            throw error;
        }
    }

    async generatePsychologicalProfile(history: any[]) {
        try {
            const prompt = \`
            Analyze the following conversation history and provide a psychological profile.
            Focus on:
            1. Emotional stability and dominant moods.
            2. Underlying concerns or recurring themes.
            3. Communication style (defensive, open, analytical, etc.).
            4. Suggestion for the user to improve well-being.
            
            History:
            ${JSON.stringify(history)}
            
            Keep it concise (approx 100 words).
            \`;

            const response = await this.openai.chat.completions.create({
                model: config.AI_MODEL,
                messages: [{ role: 'system', content: 'You are an expert psychologist AI.' }, { role: 'user', content: prompt }],
                temperature: 0.5,
                max_tokens: 300,
            });

            return response.choices[0]?.message?.content || 'No profile generated.';
        } catch (error) {
            console.error('Error generating profile:', error);
            return 'Could not generate profile at this time.';
        }
    }
}

export const aiService = new AIService();
